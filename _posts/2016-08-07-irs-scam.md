---
layout: post
title:  "IRS Scam"
date:   2016-08-07
categories: scams
---

A friend of mine and I received a message from the IRS at nearly the same time. 

<img src="/assets/initial_irs_text.jpeg" alt="drawing" width="200"/>

I replied to them, in hopes that I would be eligible to receive slightly more than the offered amount... 

<img src="/assets/irs_minion.jpeg" alt="drawing" width="200"/>

but got no response. This is when I started to suspect something was off. 

When I tried opening the link on my computer, it did not work -- the page could not be found. Opening the link on both MacOS and Windows machines gave no result, either. So, either the scammers severely misconfigured their infrastructure, or there's some silliness going on here.

Looking back to the original phishing message, we can see that it *does* specify Safari as the browser of choice... interesting. Maybe the receiving server is configured only to respond to web requests incoming from Safari browsers/User Agents. I tried crafting a request that would satisfy these requirements, but after struggling for far too long, I opted to instead open the link on my phone while monitoring its traffic and webpage elements on my computer -- an incredibly deep thank you to the following sources for helping me create this Rube Goldberg-eque phish detonation setup:

* [Inspecting web elements on iPhone via connecting to a MacBook](https://www.headspin.io/blog/tips-and-tricks-for-using-inspect-element-on-ios)
* [Viewing network traffic on an iPhone with BurpSuite](https://portswigger.net/burp/documentation/desktop/mobile/config-ios-device)


Finally! I could view the first page of the scam site:

<img src="/assets/irs_first_page.jpeg" alt="drawing" width="200"/>

Selecting "Get My Payment", we are directed to this page:

<img src="/assets/irs_second_page.jpeg" alt="drawing" width="200"/>

After filling out the fields with bogus information, I collected the .php and .js pages used to load and process the collected data. In order to prevent the usage of this malicious code elsewhere, the full deobfuscated code will not be posted here; however, I will go over chunks of the code later in this post.

Moving on to the third, final page of the site:

<img src="/assets/irs_third_page.jpeg" alt="drawing" width="200"/>

we finally get to the section which the scammers' entire operation hinges on: collecting credit card information. Upon filling these fields out and submitting the information, we are either told our credit card is invalid and that we must try again (bummer) or we are redirected to an official IRS webpage with a banner notifying us of recent scams (bummer).


We can finally get to the good part :)

## The Javascript

The site uses two Javascript files, `functions.js`{:.js} and `characters.js`{:.js} -- conveniently named so that we can understand how easily confused the scammers get -- to accomplish its goals. Looking at the smaller file, characters.js, we can see a common function implemented by scam sites: an array unshuffler. 

In order to better hide their behavior, scripts can be obfuscated by relying less on straightforward variable names and actions, and rather on storing these elements within a larger array and using a designated function to extract them using their respective positions in the array throughout the code. That's confusing. For instance, we can take the following line of obfuscated code:

```js
_0xdeadbeef = "https://"[get_word_from_array(340)]("ir")+get_word_from_array(560)
```

the function get_word_from_array(index) does exactly that -- it retrieves an element from the array, given a specific index. Oftentimes, the function will take the passed index and use it to calculate the element's *true* index using a hard-coded offset, as follows:


```js
function get_word_from_array(index)
{
    var word_array = get_word_array();
    const offset = SOME_NUMBER;
    return word_array[index-offset];
}
```

With this, we can begin to deobfuscate our jumbled code. Using get_word_from_array(*index*), we plug in the arguments seen in the code and get the following:
* get_word_from_array(340) => ".concat"
* get_word_from_array(560) => "scam.com"

So, now we have
```js
_0xdeadbeef = "https://"[".concat"]("ir")+"scam.com"
```

By the sacred, ridiculous rules of Javascript we can change ".concat" into the .concat() function due to the brackets enveloping the String. So, we have this:
```js
_0xdeadbeef = "https://".concat("ir")+"scam.com"
```

Put it all together, and we get
```js
_0xdeadbeef = "https://irscam.com"
```
likely an endpoint to either send or receive data!

This process has to be repeated for every line of obfuscated code to derive its true purpose -- a time perfect for medidation or hobbyist dissociation.

